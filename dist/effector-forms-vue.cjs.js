"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("effector"),r=require("effector-vue/composition");const i={store:function({init:r,domain:i,existing:o},t){return o||(i?i.createStore(r,t):e.createStore(r,t))},event:function({domain:r,existing:i}){return i||(r?r.createEvent():e.createEvent())}};function o(r,o,t){var n,s,l,u,a,d,c,m,v,f,p,h;const $="function"==typeof o.init?o.init():o.init,g=i.store({domain:t,existing:null===(n=o.units)||void 0===n?void 0:n.$value,init:$},{sid:`${r}-$value`}),x=i.store({domain:t,existing:null===(s=o.units)||void 0===s?void 0:s.$errors,init:[]},{sid:`${r}-$errors`}),V=x.map((e=>e[0]?e[0]:null)),b=i.store({domain:t,existing:null===(l=o.units)||void 0===l?void 0:l.$initValue,init:$},{sid:`${r}-$initValue`}),E=i.store({domain:t,existing:null===(u=o.units)||void 0===u?void 0:u.$isTouched,init:!1},{sid:`${r}-$touched`}),y=e.combine(g,b,((e,r)=>e!==r)),T=i.event({domain:t,existing:null===(a=o.units)||void 0===a?void 0:a.onChange}),F=i.event({domain:t,existing:null===(d=o.units)||void 0===d?void 0:d.onBlur}),S=i.event({domain:t,existing:null===(c=o.units)||void 0===c?void 0:c.changed}),k=i.event({domain:t,existing:null===(m=o.units)||void 0===m?void 0:m.addError}),O=i.event({domain:t,existing:null===(v=o.units)||void 0===v?void 0:v.validate}),w=i.event({domain:t,existing:null===(f=o.units)||void 0===f?void 0:f.resetErrors}),B=i.event({domain:t,existing:null===(p=o.units)||void 0===p?void 0:p.resetValue}),D=i.event({domain:t,existing:null===(h=o.units)||void 0===h?void 0:h.reset}),P=V.map((e=>null===e)),C=V.map((e=>(null==e?void 0:e.errorText)||"")),I=e.combine({value:g,errors:x,firstError:V,isValid:P,isDirty:y,isTouched:E}),j={value:g,initValue:b,isValid:P,isDirty:y,touched:E,errors:x,firstError:V,errorText:C,onChange:T,onBlur:F,addError:k,validate:O,reset:D,resetErrors:w,resetValue:B};return{changed:S,name:r,$initValue:b,$value:g,$errors:x,$firstError:V,$errorText:C,$isValid:P,$isDirty:y,$isTouched:E,$touched:E,$field:I,onChange:T,onBlur:F,addError:k,validate:O,set:T,reset:D,resetErrors:w,resetValue:B,filter:o.filter,"@@unitShape":()=>j}}function t(r){const{form:i,field:o,fieldConfig:t}=r,n=t.rules||[],s=i.validateOn||["submit"],l=t.validateOn||[],{$value:u,$errors:a,onBlur:d,changed:c,addError:m,validate:v,resetErrors:f,resetValue:p,reset:h}=o,$="function"==typeof n?e.createStore([],{sid:`${o.name}-$rulesSources`}):e.combine(n.map((({source:r},i)=>{const t=`${o.name}-$rulesSources-${i}`;return r||e.createStore(null,{sid:t})}))),g=function(e){return(r,i,o)=>{const t=[],n="function"==typeof e?e(r,i):e;for(let e=0;e<n.length;e++){const s=n[e],l=o?o[e]:null,u=s.validator(r,i,l);"boolean"!=typeof u||u||t.push({rule:s.name,errorText:s.errorText,value:r}),"object"!=typeof u||u.isValid||t.push({rule:s.name,errorText:u.errorText,value:r})}return t}}(n),x=[...s,...l],V=[];if(x.includes("submit")){const r=e.sample({source:e.combine({fieldValue:u,form:i.$values,rulesSources:$}),clock:i.submit});V.push(r)}x.includes("blur")&&V.push(e.sample({source:e.combine({fieldValue:u,form:i.$values,rulesSources:$}),clock:d})),x.includes("change")&&V.push(e.sample({source:e.combine({fieldValue:u,form:i.$values,rulesSources:$}),clock:e.merge([c,p,i.resetValues])})),V.push(e.sample({source:e.combine({fieldValue:u,form:i.$values,rulesSources:$}),clock:v})),V.push(e.sample({source:e.combine({fieldValue:u,form:i.$values,rulesSources:$}),clock:i.validate}));const b=e.sample({source:u,clock:m,fn:(e,{rule:r,errorText:i})=>({rule:r,value:e,errorText:i})}),E=e.sample({source:u,clock:i.addErrors,fn:(e,r)=>({value:e,newErrors:r})});a.on(V,((e,{form:r,fieldValue:i,rulesSources:o})=>g(i,r,o))).on(b,((e,r)=>[r,...e])).on(E,((e,{value:r,newErrors:i})=>{const t=[];for(const e of i)e.field===o.name&&t.push({value:r,rule:e.rule,errorText:e.errorText});return[...t,...e]})).reset(f,i.reset,h,i.resetErrors),x.includes("change")||a.reset(c)}function n({field:r,form:i}){const{$value:o,$initValue:t,$touched:n,onChange:s,changed:l,name:u,reset:a,resetValue:d,filter:c}=r,{setForm:m,setInitialForm:v,resetForm:f,resetTouched:p,resetValues:h}=i,$=e.sample({source:t,clock:e.merge([a,d,h,f])});n.on(l,(()=>!0)).reset(a,f,p),c?e.sample({source:s,filter:c,target:l}):e.sample({source:s,filter:()=>!0,target:l}),t.on(v,((e,r)=>r.hasOwnProperty(u)?r[u]:e)),o.on(l,((e,r)=>r)).on([m,v],((e,r)=>r.hasOwnProperty(u)?r[u]:e)).on($,((e,r)=>r))}exports.createForm=function(r){const{filter:s,domain:l,fields:u,validateOn:a,units:d}=r,c={},m=[],v=[];for(const e in u){if(!u.hasOwnProperty(e))continue;const r=o(e,u[e],l);c[e]=r,m.push(r.$isDirty),v.push(r.$touched)}const f=function(r){const i={};for(const e in r)r.hasOwnProperty(e)&&(i[e]=r[e].$value);return e.combine(i)}(c),p=function(r){const i=[];for(const e in r){if(!r.hasOwnProperty(e))continue;const{$firstError:o}=r[e];i.push(o)}return e.combine(i).map((e=>e.every((e=>null===e))))}(c),h=s?e.combine(p,s,((e,r)=>e&&r)):p,$=e.combine(m).map((e=>e.some(Boolean))),g=e.combine(v).map((e=>e.some(Boolean))),x=e.combine({isValid:p,isDirty:$,touched:g}),V=i.event({domain:l,existing:null==d?void 0:d.validate}),b=i.event({domain:l,existing:null==d?void 0:d.submit}),E=i.event({domain:l,existing:null==d?void 0:d.formValidated}),y=i.event({domain:l,existing:null==d?void 0:d.setInitialForm}),T=i.event({domain:l,existing:null==d?void 0:d.setForm}),F=i.event({domain:l,existing:null==d?void 0:d.addErrors}),S=i.event({domain:l,existing:null==d?void 0:d.reset}),k=i.event({domain:l,existing:null==d?void 0:d.resetValues}),O=i.event({domain:l,existing:null==d?void 0:d.resetErrors}),w=i.event({domain:l,existing:null==d?void 0:d.resetTouched}),B=e.sample({source:f,clock:b}),D=e.sample({source:f,clock:V});for(const e in c){if(!c.hasOwnProperty(e))continue;const r=u[e],i=c[e];n({form:{setForm:T,setInitialForm:y,resetForm:S,resetTouched:w,resetValues:k},field:i}),t({form:{$values:f,submit:b,reset:S,addErrors:F,resetValues:k,resetErrors:O,validate:V,validateOn:a},fieldConfig:r,field:i})}e.sample({source:B,filter:h,target:E}),e.sample({source:D,filter:h,target:E});const P={isValid:p,isDirty:$,touched:g,submit:b,reset:S,addErrors:F,validate:V,setForm:T,setInitialForm:y,resetTouched:w,resetValues:k,resetErrors:O,formValidated:E};return{fields:c,$values:f,$eachValid:p,$isValid:p,$isDirty:$,$touched:g,$meta:x,submit:b,validate:V,resetTouched:w,addErrors:F,reset:S,resetValues:k,resetErrors:O,setForm:T,setInitialForm:y,set:T,formValidated:E,"@@unitShape":()=>P}},exports.makeInputBinder=function(e,r){const i=e.models[r];return{modelValue:i.value,"onUpdate:modelValue":e=>{i.value=e},name:r,fields:e.fields}},exports.useForm=function(e,i){const o=null!=i&&i.length?i:Object.keys(e.fields),t={},n={};o.forEach((i=>{n[i]=r.useUnit(e.fields[i]),t[i]=r.useVModel(e.fields[i].$value)}));const s=r.useUnit(e.submit);return{models:t,fields:n,submit:s}};
